<!DOCTYPE html>
<html lang="de" data-base="../">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gravity Sandbox | Fynn Hofmann</title>
<link rel="stylesheet" href="../styles.css" />
<style>
  .page-wrap { max-width: 1080px; margin: 0 auto; padding: 0 24px; }
  .section    { padding: 48px 0 80px; }

  /* Controls */
  .sim-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }

  .ctrl-pill {
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--bg-light);
    border-radius: 12px;
    padding: 10px 16px;
  }

  .ctrl-label {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    white-space: nowrap;
  }

  .ctrl-range {
    -webkit-appearance: none;
    width: 90px;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    outline: none;
    cursor: pointer;
  }
  .ctrl-range::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    transition: transform 0.15s;
  }
  .ctrl-range::-webkit-slider-thumb:hover { transform: scale(1.1); }

  .ctrl-val {
    font-size: 13px;
    font-weight: 500;
    color: var(--accent);
    min-width: 28px;
    font-variant-numeric: tabular-nums;
  }

  .ctrl-btn {
    padding: 10px 18px;
    border: 1.5px solid var(--border);
    border-radius: 12px;
    background: var(--white);
    font-family: var(--font);
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s, background 0.2s;
    white-space: nowrap;
  }
  .ctrl-btn:hover { border-color: var(--accent); color: var(--accent); }
  .ctrl-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }

  /* Canvas */
  .canvas-wrap {
    width: 100%;
    background: #000;
    border-radius: var(--radius);
    overflow: hidden;
    aspect-ratio: 16 / 9;
    position: relative;
    cursor: crosshair;
    box-shadow: 0 24px 80px rgba(0,0,0,0.35);
    touch-action: none;
    user-select: none;
  }

  #simCanvas {
    display: block;
    width: 100%;
    height: 100%;
  }

  /* Hint overlay */
  .canvas-hint {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    transition: opacity 0.6s ease;
  }
  .hint-box {
    background: rgba(10,10,20,0.72);
    backdrop-filter: blur(16px) saturate(180%);
    -webkit-backdrop-filter: blur(16px) saturate(180%);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 18px;
    padding: 28px 44px;
    text-align: center;
    color: rgba(255,255,255,0.75);
    max-width: 380px;
  }
  .hint-box h3 {
    font-size: 20px;
    font-weight: 700;
    color: #fff;
    margin-bottom: 10px;
    letter-spacing: -0.02em;
  }
  .hint-box p {
    font-size: 14px;
    line-height: 1.65;
  }

  /* Info bar */
  .sim-info {
    display: flex;
    align-items: center;
    gap: 24px;
    flex-wrap: wrap;
    margin-top: 18px;
  }
  .sim-stat {
    font-size: 13px;
    color: var(--text-secondary);
  }
  .sim-stat strong {
    color: var(--text);
    font-weight: 600;
  }
  .sim-hint-text {
    margin-left: auto;
    font-size: 12px;
    color: var(--text-tertiary);
  }

  @media (max-width: 640px) {
    .canvas-wrap { aspect-ratio: 4 / 3; }
    .ctrl-range   { width: 64px; }
    .sim-hint-text { display: none; }
  }
</style>
</head>
<body>

<section class="page-hero">
  <div class="page-wrap">
    <span class="page-hero-eyebrow">Simulation</span>
    <h1 class="page-hero-title">Gravity Sandbox.</h1>
    <p class="page-hero-sub">Setze Planeten ins All und beobachte, wie sie sich gegenseitig anziehen.</p>
  </div>
</section>

<main class="section">
  <div class="page-wrap">

    <!-- Controls -->
    <div class="sim-controls">
      <div class="ctrl-pill">
        <span class="ctrl-label">Gravitation</span>
        <input type="range" class="ctrl-range" id="gRange" min="0.5" max="8" step="0.5" value="3"
          oninput="G_MULT=+this.value;document.getElementById('gVal').textContent=this.value" />
        <span class="ctrl-val" id="gVal">3</span>
      </div>

      <div class="ctrl-pill">
        <span class="ctrl-label">Spur</span>
        <input type="range" class="ctrl-range" id="trailRange" min="0.02" max="0.5" step="0.02" value="0.12"
          oninput="TRAIL_ALPHA=+this.value;document.getElementById('trailVal').textContent=Math.round(this.value*100)+'%'" />
        <span class="ctrl-val" id="trailVal">12%</span>
      </div>

      <div class="ctrl-pill">
        <span class="ctrl-label">Masse</span>
        <input type="range" class="ctrl-range" id="massRange" min="5" max="60" step="5" value="15"
          oninput="NEXT_MASS=+this.value;document.getElementById('massVal').textContent=this.value" />
        <span class="ctrl-val" id="massVal">15</span>
      </div>

      <button class="ctrl-btn active" id="mergeBtn" onclick="toggleMerge()">Kollision an</button>
      <button class="ctrl-btn" onclick="addSolarSystem()">Sonnensystem</button>
      <button class="ctrl-btn" onclick="addChaos()">Chaos</button>
      <button class="ctrl-btn" onclick="clearAll()">Leeren</button>
    </div>

    <!-- Canvas -->
    <div class="canvas-wrap" id="canvasWrap">
      <canvas id="simCanvas"></canvas>
      <div class="canvas-hint" id="hint">
        <div class="hint-box">
          <h3>Gravity Sandbox</h3>
          <p>Klicken &amp; Ziehen, um einen Planeten mit Geschwindigkeit zu platzieren.<br/>
          Oder ein Preset wählen – und zuschauen.</p>
        </div>
      </div>
    </div>

    <!-- Info -->
    <div class="sim-info">
      <div class="sim-stat">Planeten: <strong id="statBodies">0</strong></div>
      <div class="sim-stat">Kollisionen: <strong id="statMerges">0</strong></div>
      <div class="sim-stat">FPS: <strong id="statFps">–</strong></div>
      <span class="sim-hint-text">Klick + Ziehen → Geschwindigkeit setzen · Scrollrad → Masse ändern</span>
    </div>

  </div>
</main>

<script src="../components.js"></script>
<script>
/* =========================================================
   Gravity Sandbox – N-body physics on canvas
   ========================================================= */

const canvas = document.getElementById('simCanvas');
const ctx    = canvas.getContext('2d');
const wrap   = document.getElementById('canvasWrap');

let W = 0, H = 0;
let bodies  = [];
let stars   = [];
let drag    = null;
let merges  = 0;
let MERGE       = true;
let G_MULT      = 3;
let TRAIL_ALPHA = 0.12;
let NEXT_MASS   = 15;

/* ── Resize ────────────────────────────────────────────── */
function resize() {
  const r = wrap.getBoundingClientRect();
  canvas.width  = W = Math.round(r.width);
  canvas.height = H = Math.round(r.height);
  makeStars();
  // Re-fill background so trail doesn't show blank strip
  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, W, H);
}

function makeStars() {
  stars = [];
  const n = Math.floor((W * H) / 2800);
  for (let i = 0; i < n; i++) {
    stars.push({
      x: Math.random() * W,
      y: Math.random() * H,
      r: Math.random() * 1.1 + 0.2,
      a: Math.random() * 0.55 + 0.15,
    });
  }
}

/* ── Body ─────────────────────────────────────────────── */
class Body {
  constructor(x, y, mass, vx, vy, hue) {
    this.x  = x;  this.y  = y;
    this.vx = vx || 0; this.vy = vy || 0;
    this.ax = 0;  this.ay = 0;
    this.mass = mass;
    this.r    = Math.cbrt(mass) * 2.4;
    this.hue  = hue !== undefined ? hue : Math.random() * 360;
  }
  get solid() { return `hsl(${this.hue},75%,65%)`; }
  get glow()  { return `hsla(${this.hue},85%,60%,0.22)`; }
  get glowMid(){ return `hsla(${this.hue},80%,62%,0.08)`; }
}

/* ── Physics ──────────────────────────────────────────── */
const G_BASE = 600;

function step(dt) {
  const n = bodies.length;
  const G = G_BASE * G_MULT / 3;

  for (let i = 0; i < n; i++) { bodies[i].ax = 0; bodies[i].ay = 0; }

  for (let i = 0; i < n; i++) {
    for (let j = i + 1; j < n; j++) {
      const bi = bodies[i], bj = bodies[j];
      const dx = bj.x - bi.x;
      const dy = bj.y - bi.y;
      const dist2 = dx*dx + dy*dy;
      const dist  = Math.sqrt(dist2) || 0.001;
      const minD  = bi.r + bj.r;

      // Merge
      if (MERGE && dist < minD * 0.75) {
        const tm = bi.mass + bj.mass;
        bi.vx = (bi.vx * bi.mass + bj.vx * bj.mass) / tm;
        bi.vy = (bi.vy * bi.mass + bj.vy * bj.mass) / tm;
        bi.x  = (bi.x  * bi.mass + bj.x  * bj.mass) / tm;
        bi.y  = (bi.y  * bi.mass + bj.y  * bj.mass) / tm;
        // Blend hue weighted by mass
        bi.hue = (bi.hue * bi.mass + bj.hue * bj.mass) / tm;
        bi.mass = tm;
        bi.r    = Math.cbrt(tm) * 2.4;
        bodies.splice(j, 1);
        merges++;
        document.getElementById('statMerges').textContent = merges;
        return; // recompute next frame
      }

      // Softened gravity
      const soft = Math.max(dist, minD * 0.5);
      const F  = G * bi.mass * bj.mass / (soft * soft);
      const fx = F * dx / dist;
      const fy = F * dy / dist;
      bi.ax += fx / bi.mass; bi.ay += fy / bi.mass;
      bj.ax -= fx / bj.mass; bj.ay -= fy / bj.mass;
    }
  }

  for (const b of bodies) {
    b.vx += b.ax * dt; b.vy += b.ay * dt;
    b.x  += b.vx * dt; b.y  += b.vy * dt;
    // Wrap
    if (b.x < -b.r*3) b.x = W + b.r;
    if (b.x >  W+b.r*3) b.x = -b.r;
    if (b.y < -b.r*3) b.y = H + b.r;
    if (b.y >  H+b.r*3) b.y = -b.r;
  }
}

/* ── Draw ─────────────────────────────────────────────── */
function draw() {
  // Trail fade
  ctx.fillStyle = `rgba(0,0,0,${TRAIL_ALPHA})`;
  ctx.fillRect(0, 0, W, H);

  // Stars (always redrawn so they stay visible)
  for (const s of stars) {
    ctx.beginPath();
    ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(255,255,255,${s.a * TRAIL_ALPHA * 8})`;
    ctx.fill();
  }

  // Bodies
  for (const b of bodies) {
    // Outer glow
    const g1 = ctx.createRadialGradient(b.x, b.y, 0, b.x, b.y, b.r * 3.5);
    g1.addColorStop(0,   b.glow);
    g1.addColorStop(0.5, b.glowMid);
    g1.addColorStop(1,   'rgba(0,0,0,0)');
    ctx.beginPath();
    ctx.arc(b.x, b.y, b.r * 3.5, 0, Math.PI * 2);
    ctx.fillStyle = g1;
    ctx.fill();

    // Sphere
    const hx = b.x - b.r * 0.35;
    const hy = b.y - b.r * 0.35;
    const g2 = ctx.createRadialGradient(hx, hy, 0, b.x, b.y, b.r);
    g2.addColorStop(0,   'rgba(255,255,255,0.85)');
    g2.addColorStop(0.25, b.solid);
    g2.addColorStop(1,   b.solid);
    ctx.beginPath();
    ctx.arc(b.x, b.y, b.r, 0, Math.PI * 2);
    ctx.fillStyle = g2;
    ctx.fill();
  }

  // Drag preview
  if (drag) {
    const dx = drag.ex - drag.sx;
    const dy = drag.ey - drag.sy;
    const len = Math.hypot(dx, dy);

    // Ghost planet at origin
    const r = Math.cbrt(NEXT_MASS) * 2.4;
    ctx.beginPath();
    ctx.arc(drag.sx, drag.sy, r, 0, Math.PI * 2);
    ctx.fillStyle   = 'rgba(255,255,255,0.18)';
    ctx.strokeStyle = 'rgba(255,255,255,0.65)';
    ctx.lineWidth   = 1.5;
    ctx.fill();
    ctx.stroke();

    if (len > 8) {
      // Velocity arrow
      const angle = Math.atan2(dy, dx);
      ctx.save();
      ctx.strokeStyle = 'rgba(255,255,255,0.6)';
      ctx.lineWidth   = 1.8;
      ctx.setLineDash([6, 5]);
      ctx.beginPath();
      ctx.moveTo(drag.sx, drag.sy);
      ctx.lineTo(drag.ex, drag.ey);
      ctx.stroke();
      ctx.setLineDash([]);

      // Arrow head
      const tip = 11;
      ctx.beginPath();
      ctx.moveTo(drag.ex, drag.ey);
      ctx.lineTo(drag.ex - tip * Math.cos(angle - 0.42), drag.ey - tip * Math.sin(angle - 0.42));
      ctx.lineTo(drag.ex - tip * Math.cos(angle + 0.42), drag.ey - tip * Math.sin(angle + 0.42));
      ctx.closePath();
      ctx.fillStyle = 'rgba(255,255,255,0.6)';
      ctx.fill();
      ctx.restore();
    }
  }
}

/* ── Loop ─────────────────────────────────────────────── */
let lastTs = 0, fpsTs = 0, fpsN = 0;

function loop(ts) {
  const dt = Math.min((ts - lastTs) / 1000, 0.05);
  lastTs = ts;

  fpsN++;
  if (ts - fpsTs > 600) {
    document.getElementById('statFps').textContent =
      Math.round(fpsN * 1000 / (ts - fpsTs));
    fpsN = 0; fpsTs = ts;
  }
  document.getElementById('statBodies').textContent = bodies.length;

  const sub = 3;
  for (let i = 0; i < sub; i++) step(dt / sub);
  draw();
  requestAnimationFrame(loop);
}

/* ── Presets ──────────────────────────────────────────── */
function clearAll() {
  bodies = [];
  merges = 0;
  document.getElementById('statMerges').textContent = '0';
  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, W, H);
}

function addSolarSystem() {
  clearAll();
  hideHint();
  const cx = W / 2, cy = H / 2;

  // Sun
  const sun = new Body(cx, cy, 220, 0, 0, 45);
  sun.r = Math.cbrt(220) * 2.8;
  bodies.push(sun);

  // Planets: [dist, mass, hue, name]
  const planets = [
    [70,   6, 220],  // mercury-blue
    [110, 10, 30 ],  // venus-warm
    [160, 13, 200],  // earth-blue
    [210,  9, 12 ],  // mars-red
    [270, 22, 28 ],  // jupiter-orange
    [330, 17, 180],  // saturn-teal
  ];

  const Geff = G_BASE * G_MULT / 3;
  for (const [d, m, h] of planets) {
    const v = Math.sqrt(Geff * sun.mass / d);
    // Random start angle for variety
    const angle = Math.random() * Math.PI * 2;
    const b = new Body(
      cx + d * Math.cos(angle),
      cy + d * Math.sin(angle),
      m,
      -v * Math.sin(angle),
       v * Math.cos(angle),
      h
    );
    bodies.push(b);
  }
}

function addChaos() {
  clearAll();
  hideHint();
  const n = 12;
  for (let i = 0; i < n; i++) {
    const x = W * 0.1 + Math.random() * W * 0.8;
    const y = H * 0.1 + Math.random() * H * 0.8;
    const m = 8 + Math.random() * 22;
    const vx = (Math.random() - 0.5) * 80;
    const vy = (Math.random() - 0.5) * 80;
    bodies.push(new Body(x, y, m, vx, vy));
  }
}

/* ── Controls ─────────────────────────────────────────── */
function toggleMerge() {
  MERGE = !MERGE;
  const btn = document.getElementById('mergeBtn');
  btn.classList.toggle('active', MERGE);
  btn.textContent = MERGE ? 'Kollision an' : 'Kollision aus';
}

function hideHint() {
  document.getElementById('hint').style.opacity = '0';
}

/* ── Pointer events ───────────────────────────────────── */
function canvasPos(e) {
  const r = canvas.getBoundingClientRect();
  const scaleX = canvas.width  / r.width;
  const scaleY = canvas.height / r.height;
  const src = e.touches ? e.touches[0] : e;
  return {
    x: (src.clientX - r.left) * scaleX,
    y: (src.clientY - r.top)  * scaleY,
  };
}

canvas.addEventListener('mousedown', e => {
  const p = canvasPos(e);
  drag = { sx: p.x, sy: p.y, ex: p.x, ey: p.y };
});
canvas.addEventListener('mousemove', e => {
  if (!drag) return;
  const p = canvasPos(e);
  drag.ex = p.x; drag.ey = p.y;
});
canvas.addEventListener('mouseup', e => {
  if (!drag) return;
  spawnBody();
  drag = null;
  hideHint();
});
canvas.addEventListener('mouseleave', () => { drag = null; });

canvas.addEventListener('touchstart', e => {
  e.preventDefault();
  const p = canvasPos(e);
  drag = { sx: p.x, sy: p.y, ex: p.x, ey: p.y };
}, { passive: false });
canvas.addEventListener('touchmove', e => {
  e.preventDefault();
  if (!drag) return;
  const p = canvasPos(e);
  drag.ex = p.x; drag.ey = p.y;
}, { passive: false });
canvas.addEventListener('touchend', e => {
  e.preventDefault();
  if (!drag) return;
  spawnBody();
  drag = null;
  hideHint();
}, { passive: false });

// Scroll wheel → adjust next mass
canvas.addEventListener('wheel', e => {
  e.preventDefault();
  NEXT_MASS = Math.max(5, Math.min(60, NEXT_MASS - Math.sign(e.deltaY) * 5));
  document.getElementById('massRange').value = NEXT_MASS;
  document.getElementById('massVal').textContent = NEXT_MASS;
}, { passive: false });

function spawnBody() {
  const dx = drag.ex - drag.sx;
  const dy = drag.ey - drag.sy;
  const SPEED = 2.8;
  bodies.push(new Body(drag.sx, drag.sy, NEXT_MASS, dx * SPEED, dy * SPEED));
}

/* ── Init ─────────────────────────────────────────────── */
window.addEventListener('resize', resize);
resize();

ctx.fillStyle = '#000';
ctx.fillRect(0, 0, W, H);

// Draw initial stars on black bg
for (const s of stars) {
  ctx.beginPath();
  ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
  ctx.fillStyle = `rgba(255,255,255,${s.a})`;
  ctx.fill();
}

requestAnimationFrame(ts => { lastTs = ts; fpsTs = ts; loop(ts); });
</script>
</body>
</html>
